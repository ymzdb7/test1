<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.winhands.base.user.repository.MBUserDao">
	<!--
		获取用户: 输出直接映射到对象, login_name列要"as loginName"以方便映射 ,team_id as "team.id"创建team对象并赋值
	--> 
	   
	<select id="queryUserList" parameterType="Map" resultType="User">
	      SELECT t1.user_id userId, t1.user_code userCode, t1.user_name userName, t1.user_name_cn userNameCn, password, user_op_time userOpTime,
		         t1.user_build_id, t1.user_destroy, t1.user_destroy_date, t1.password_update, 
		         t1.user_type userType, t1.user_extend1, t1.user_extend2, t1.user_extend3, t1.user_extend4, 
		         t1.user_extend5, t1.user_extend6, t1.org_id, user_order userOrder, parent_user_id,
		         t1.user_phone userPhone, t1.user_mail, t1.salt,last_login_time lastLoginTime
		  FROM t_users t1
          WHERE  1 = 1
		   <if test="userName != null and userName != ''">
	            and t1.user_name like    CONCAT('%','${userName}','%' )
	   	   </if>
	   	   <if test="userPhone != null and userPhone != ''">  
	            and t1.user_phone like    CONCAT('%','${userPhone}','%' )
			</if>
			 <if test="orgId != null and orgId != ''">  
	            and t1.org_id =  #{orgId}
			</if>
			order by t1.user_order
	</select>

	<select id="queryChefList" parameterType="Map" resultType="User">
	   SELECT
	      tt1.userId, tt1.userName, tt1.userNameCn,  
		  tt1.userType,tt1.orgName,tt1.user_order,tt1.order_id,
		  tt1.userPhone,case when tt2.chef_id is null then 0 else 1 end  as userExtend6
	   FROM 
	      (
	      SELECT t1.user_id userId, t1.user_code userCode, t1.user_name userName, t1.user_name_cn userNameCn, password, user_op_time, 
		         t1.user_build_id, t1.user_destroy, t1.user_destroy_date, t1.password_update, 
		         t1.user_type userType, t1.user_extend1, t1.user_extend2, t1.user_extend3, t1.user_extend4, 
		         t1.user_extend5, t1.user_extend6, t1.org_id, t2.org_name orgName, user_order userOrder, parent_user_id, 
		         t1.user_phone userPhone, t1.user_mail, t1.salt,t1.org_id1,t1.org_id2,t1.org_id3,t2.order_id,t1.user_order
		  FROM t_users t1,t_org t2
          where t1.org_id = t2.org_id
		    <if test="user_type != null and user_type != ''">  
	            and t1.user_type =  #{user_type}
	   	   </if>   
	   	   <if test="orgId != null and orgId != ''">  
	            and t1.org_id =  #{orgId}
	   	   </if>  
	   	   <if test="userName != null and userName != ''">  
	            and t1.user_name like    CONCAT('%','${userName}','%' )
	   	   </if>
	   	   <if test="userPhone != null and userPhone != ''">  
	            and t1.user_phone like    CONCAT('%','${userPhone}','%' )
	   	   </if>
	   	   ) tt1 left join (
	   	    SELECT id, chef_id, chef_name, train_id, train_name, train_tec, score, 
                  grade, create_user_id, create_date, spare_1, spare_2, spare_3
            FROM t_train_chef_score
            where train_id = #{train_id}
	   	  ) tt2
	   	  on tt1.userId = tt2.chef_id 
	   	  order by tt1.order_id,tt1.user_order
	</select>
	<select id="findUserByOrgId" parameterType="Map" resultType="User">
		SELECT t1.user_id userId, t1.user_code userCode, t1.user_name userName, t1.user_name_cn userNameCn, password, user_op_time, 
		         t1.user_build_id, t1.user_destroy, t1.user_destroy_date, t1.password_update, 
		         t1.user_type userType, t1.user_extend1, t1.user_extend2, t1.user_extend3, t1.user_extend4, 
		         t1.user_extend5, t1.user_extend6, t1.org_id, t1.org_name orgName, user_order userOrder, parent_user_id, 
		         t1.user_phone userPhone, t1.user_mail, t1.salt,t1.org_id1,t1.org_id2,t1.org_id3
		  FROM t_users t1
		  <where>
		    <if test="orgId != null and orgId != ''">  
	            and t1.org_id =  #{orgId}
	   	   </if>
	   	   <if test="userType != null and userType != ''">  
	            and t1.user_type =  #{userType}
	   	   </if> 
	   	   </where>    
	</select>

    <!--根据用户id修改最后登录时间-->
    <update id="updateLastLoginByUserId" parameterType="String">
        UPDATE t_users SET last_login_time = now() WHERE user_id = #{$}
    </update>
</mapper> 